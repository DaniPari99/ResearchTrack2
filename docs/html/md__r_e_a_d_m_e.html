<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Final assignment: Research Track I - final assignment</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Final assignment
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">ROS package for the final assignment</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Research Track I - final assignment </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><hr  />
<p>Parisi Daniele Martino 4670964</p>
<p>The final assignment requires to write the code for moving a robot in the environment initially unknown. Three modalities for moving the robot are required:</p><ul>
<li>the robot has to reach a goal chosen by the user</li>
<li>the robot is driven by the user through the keyboard</li>
<li>the robot is driven by the user with the assistence of a collision avoidence architecture</li>
</ul>
<p>This is the final assignment's environment visualized with Gazebo: <img src="https://user-images.githubusercontent.com/62515616/152884108-da0032b9-8a4f-4565-8503-6839d839a8f2.png" alt="MicrosoftTeams-image(4)" class="inline"/></p>
<p>Initially the robot does not have a map of the environment, but it can build it through the laser scanner and thanks to the <b>gmapping</b> package. The final map built by the robot is visualized in Rviz as follows:</p>
<p><img src="https://user-images.githubusercontent.com/62515616/152884728-46a1fe86-923b-4e8d-9b25-a15c8540d695.png" alt="MicrosoftTeams-image(3)" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md2"></a>
How to run the simulation</h1>
<p>In order to launch different nodes with only a command I implemented a launch file called <b>final.launch</b> that is the following: </p><div class="fragment"><div class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</div>
<div class="line"> </div>
<div class="line">&lt;launch&gt;</div>
<div class="line">    &lt;include file=&quot;$(find final_assignment)/launch/simulation_gmapping.launch&quot; /&gt;</div>
<div class="line">    &lt;include file=&quot;$(find final_assignment)/launch/move_base.launch&quot; /&gt;</div>
<div class="line">    &lt;node pkg=&quot;final_assignment&quot; type=&quot;user_interface&quot; name=&quot;user_interface&quot; output=&quot;screen&quot; required=&quot;true&quot; launch-prefix=&quot;xterm -e&quot;/&gt;</div>
<div class="line">    &lt;node pkg=&quot;final_assignment&quot; type=&quot;server&quot; name=&quot;server&quot; output=&quot;screen&quot; required=&quot;true&quot; launch-prefix=&quot;xterm -e&quot;/&gt;</div>
<div class="line">     &lt;node pkg=&quot;teleop_twist_keyboard&quot; type=&quot;teleop_twist_keyboard.py&quot; name=&quot;teleop&quot; output=&quot;screen&quot; launch-prefix=&quot;xterm -e&quot; respawn=&quot;true&quot;&gt;</div>
<div class="line">    &lt;remap from=&quot;cmd_vel&quot; to=&quot;new_cmd_vel&quot;/&gt;</div>
<div class="line">   &lt;/node&gt;</div>
<div class="line">&lt;/launch&gt;</div>
</div><!-- fragment --><p>it contains 2 nested launch file: <b>simulation_gmapping.launch</b> and <b>move_base.launch</b> which respectively launch the simulation environment and provide some tools for moving the robot in the environment.</p>
<p>It can be launched with the command:</p>
<div class="fragment"><div class="line">$ roslaunch final_assignment final.launch</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md3"></a>
Project structure</h1>
<p><img src="https://user-images.githubusercontent.com/62515616/152952323-427302ad-438c-4cdf-b08c-16b1f12a519a.png" alt="gr" class="inline"/> As we can see from this graph, we have 9 nodes overall, even if **/user_interface** and <b>gazebo_gui</b> are not relationed with nothing. I choose to remap **/cmd_vel** topic from /cmd_vel to **/new_cmd_vel** according to achieve the specification regarding the 3rd modality for driving the robot avoiding the obstacles. In this way the **/server** node is subscribed to the remapped topic **/new_cmd_vel** and can check if the current velocities imposed by the user can cause collisions. In this case the values of the velocities are modified and published to the actual **/cmd_vel** according to stop the robot in difficulty situations. **/server** node is linked to **/move_base** according to publish on **/move_base/goal** the goal chosen by the user in the 1st modality; for this purpose I also implemented a subscriber to the topic **/move_base/feedback** according to get the real-time position of the robot and check if the goal is reain this case I have a publisher to the topic **/move_base/** for cancelling the current goal once is reached. **/server** is also connected to **/gazebo** for receiving the laser scanner data on **/scan** topic.</p>
<h1><a class="anchor" id="autotoc_md4"></a>
Pseudo-code</h1>
<p>The behaviour of the most important node of the assignment: <b>server</b> can be summarize by the following pseudo-code:</p>
<p>Whenever the user types a correct command in the user_interface shell the serviceCallback is executed: </p><div class="fragment"><div class="line">if command = 1</div>
<div class="line"> </div>
<div class="line">    print &quot;what target do you want to achieve?&quot;</div>
<div class="line">    </div>
<div class="line">    get from input keyboard the goal chosen</div>
<div class="line">    </div>
<div class="line">    set the bool variable &#39;goal&#39; to true</div>
<div class="line">    </div>
<div class="line">    set the goal_msg fields pos_x and pos_y with the chosen coordinates</div>
<div class="line">    </div>
<div class="line">    publish goal_msg on topic move_base/goal</div>
<div class="line"> </div>
<div class="line">else if command = 2</div>
<div class="line"> </div>
<div class="line">    set the bool variable manDrive to true</div>
<div class="line">    </div>
<div class="line">    set collisionAvoidence variable to false</div>
<div class="line">    </div>
<div class="line">else if command = 3</div>
<div class="line"> </div>
<div class="line">    set collisionAvoidence variable to true</div>
<div class="line">    </div>
<div class="line">    set the bool variable manDrive to false</div>
</div><!-- fragment --><p>Whenever the user try to change the velocities from the teleop_twist_keyboard 'getVelCallback' is executed: </p><div class="fragment"><div class="line">if we are in the 1st modality</div>
<div class="line"> </div>
<div class="line">    the keyboard is not considered</div>
<div class="line">    </div>
<div class="line">else if we are in the 2nd modality</div>
<div class="line"> </div>
<div class="line">    the keyboard is considered and the velocities are published on topic /cmd_vel</div>
<div class="line">    </div>
<div class="line">else if we are in the 3rd modality</div>
<div class="line"> </div>
<div class="line">    the message is saved in a global variable and maybe it will be corrected by the collisionAvoidenceCallback before being published</div>
</div><!-- fragment --><p>Whenever the position of the robot changes 'currentPositionCallback' is executed: </p><div class="fragment"><div class="line">if goal is set to true</div>
<div class="line"> </div>
<div class="line">    get the current position of the robot</div>
<div class="line">    </div>
<div class="line">    calculate the distance between the goal and the robot position</div>
<div class="line">    </div>
<div class="line">    if this distance is less than or equal to a threshold</div>
<div class="line">    </div>
<div class="line">        print &quot;goal reached&quot;</div>
<div class="line">        </div>
<div class="line">        cancel the goal</div>
</div><!-- fragment --><p>Whenever a message from laserScan is received and we are in the 3rd modality 'collisionAvoidenceCallback' is executed: </p><div class="fragment"><div class="line">divide the array &#39;ranges&#39; returned by the LaserScan topic in 5 sector (right, front_right, front, fron_left, left) and fill them appropriately</div>
<div class="line"> </div>
<div class="line">if min_front_dist is less than a threshold</div>
<div class="line"> </div>
<div class="line">    if linear velocity is greater than 0 and angular velocity is equal to zero</div>
<div class="line">    </div>
<div class="line">        stop the robot</div>
<div class="line">        </div>
<div class="line">if min_front_left_dist is less than a threshold</div>
<div class="line"> </div>
<div class="line">    if linear velocity is greater than 0 and angular velocity is greater than zero</div>
<div class="line">    </div>
<div class="line">        stop the robot</div>
<div class="line">        </div>
<div class="line">if min_front_right_dist is less than or equal to a threshold</div>
<div class="line"> </div>
<div class="line">    if linear velocity is greater than 0 and angular velocity is less than zero</div>
<div class="line">    </div>
<div class="line">        stop the robot</div>
<div class="line">        </div>
<div class="line">if min_left_dist is less than or equal to a threshold</div>
<div class="line"> </div>
<div class="line">    if linear velocity is equal to 0 and angular velocity is greater than zero</div>
<div class="line">    </div>
<div class="line">        stop the robot</div>
<div class="line">        </div>
<div class="line">if min_right_dist is less than or equal to a threshold</div>
<div class="line"> </div>
<div class="line">    if linear velocity is equal to 0 and angular velocity is less than zero</div>
<div class="line">    </div>
<div class="line">        stop the robot</div>
<div class="line">        </div>
<div class="line">publish corrected velocity on topic /cmd_vel</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md5"></a>
System limitations and possible improvements</h1>
<h2><a class="anchor" id="autotoc_md6"></a>
Limitations:</h2>
<ul>
<li>it is not considered the case in which the user chooses a goal that is not reachable, so in this case the robot will move infinitely to search the target position as long as the user either changes goal or modality</li>
<li>in the case in which the user sends 2 or more targets one immediately after the other, the robot will try to reach the last one chosen</li>
</ul>
<h2><a class="anchor" id="autotoc_md7"></a>
Possible improvements</h2>
<ul>
<li>it can be checked if the goal chosen is reachable or not and in this case printing a message in the console like 'the target chosen is not reachable, retype'</li>
<li>it can be implemented a logic that stores in a queue more than one goal chosen, according to reach them sequentially </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
